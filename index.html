<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–º–µ–π–∫–∞ - –†–µ–∫–æ—Ä–¥—ã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .game-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .game-layout {
                grid-template-columns: 1fr;
            }
        }
        
        .game-container {
            position: relative;
        }
        
        #gameCanvas {
            border: 3px solid #333;
            border-radius: 10px;
            background: #000;
            display: block;
            margin: 0 auto;
        }
        
        .game-controls {
            text-align: center;
            margin: 15px 0;
        }
        
        .controls button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 5px;
            transition: transform 0.2s;
        }
        
        .controls button:hover {
            transform: translateY(-2px);
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        .score-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .score-item .score {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        
        .score-item .level {
            color: #666;
            font-size: 0.9em;
        }
        
        .score-item .date {
            color: #888;
            font-size: 0.8em;
            text-align: right;
        }
        
        .current-stats {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .player-input {
            margin: 20px 0;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .new-record {
            animation: pulse 1s infinite;
            background: linear-gradient(135deg, #ffd93d 0%, #ff6b6b 100%) !important;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
        }
        
        .game-over h2 {
            color: #ff6b6b;
            margin-bottom: 15px;
            font-size: 2em;
        }
        
        .mobile-controls {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .mobile-controls {
                display: grid;
            }
        }
        
        .mobile-controls button {
            background: rgba(102, 126, 234, 0.8);
            color: white;
            border: none;
            padding: 20px;
            font-size: 1.5em;
            border-radius: 10px;
        }
        
        .control-up { grid-column: 2; grid-row: 1; }
        .control-left { grid-column: 1; grid-row: 2; }
        .control-right { grid-column: 3; grid-row: 2; }
        .control-down { grid-column: 2; grid-row: 2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêç –ó–º–µ–π–∫–∞ - –†–µ–∫–æ—Ä–¥—ã</h1>
        
        <div class="game-layout">
            <div class="game-container">
                <canvas id="gameCanvas" width="600" height="400"></canvas>
                <div class="game-controls">
                    <div class="controls">
                        <button onclick="startGame()">üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                        <button onclick="pauseGame()">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
                        <button onclick="saveScore()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–æ—Ä–¥</button>
                    </div>
                </div>
                
                <div class="mobile-controls">
                    <button class="control-up" onclick="changeDirection('up')">‚Üë</button>
                    <button class="control-left" onclick="changeDirection('left')">‚Üê</button>
                    <button class="control-right" onclick="changeDirection('right')">‚Üí</button>
                    <button class="control-down" onclick="changeDirection('down')">‚Üì</button>
                </div>
                
                <div id="gameOver" class="game-over">
                    <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                    <p>–í–∞—à —Å—á–µ—Ç: <span id="final-score">0</span></p>
                    <p>–£—Ä–æ–≤–µ–Ω—å: <span id="final-level">1</span></p>
                    <button onclick="startGame()">üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="current-stats">
                    <h2>–¢–µ–∫—É—â–∞—è –∏–≥—Ä–∞</h2>
                    <div class="stats-grid">
                        <div class="stat">
                            <div class="stat-value" id="current-score">0</div>
                            <div class="stat-label">–û–ß–ö–ò</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="current-level">1</div>
                            <div class="stat-label">–£–†–û–í–ï–ù–¨</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="snake-length">1</div>
                            <div class="stat-label">–î–õ–ò–ù–ê</div>
                        </div>
                    </div>
                    
                    <div class="player-input">
                        <input type="text" id="player-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" maxlength="20">
                    </div>
                </div>
                
                <div class="section">
                    <h2>üèÜ –í–∞—à–∏ –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
                    <div id="personal-results" class="loading">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìä –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
                    <div id="leaderboard" class="loading">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üîß –ù–ê–°–¢–†–û–ô–ö–ò - –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï –° SUPABASE
        const SUPABASE_URL = 'https://uxkbeldvmmayqflsqpzw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4a2JlbGR2bW1heXFmbHNxcHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MDk0OTcsImV4cCI6MjA3NjI4NTQ5N30.55B-bBS0yAD4G1srxbPx0CdwSCZgnS2gycAg_hLmwb0';

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
        let canvas, ctx;
        let snake = [];
        let food = {};
        let gridSize = 20;
        let direction = 'right';
        let gameLoop;
        let isPaused = false;
        let isGameOver = false;
        let currentScore = 0;
        let currentLevel = 1;
        let snakeLength = 1;
        let gameSpeed = 150;
        let playerName = '';
        let personalBest = 0;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            resetGame();
            loadScores();
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            document.addEventListener('keydown', handleKeyPress);
        }

        function resetGame() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–º–µ–π–∫—É
            snake = [{x: 5, y: 10}];
            snakeLength = 1;
            
            // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—É—é –µ–¥—É
            createFood();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç –∏ —É—Ä–æ–≤–µ–Ω—å
            currentScore = 0;
            currentLevel = 1;
            gameSpeed = 150;
            direction = 'right';
            isGameOver = false;
            isPaused = false;
            
            document.getElementById('gameOver').style.display = 'none';
            updateDisplay();
        }

        function startGame() {
            if (gameLoop) {
                clearInterval(gameLoop);
            }
            resetGame();
            gameLoop = setInterval(updateGame, gameSpeed);
        }

        function pauseGame() {
            if (isGameOver) return;
            
            isPaused = !isPaused;
            if (isPaused) {
                clearInterval(gameLoop);
            } else {
                gameLoop = setInterval(updateGame, gameSpeed);
            }
        }

        function updateGame() {
            if (isPaused || isGameOver) return;
            
            moveSnake();
            checkCollision();
            checkFood();
            drawGame();
        }

        function moveSnake() {
            const head = {...snake[0]};
            
            switch(direction) {
                case 'up': head.y--; break;
                case 'down': head.y++; break;
                case 'left': head.x--; break;
                case 'right': head.x++; break;
            }
            
            snake.unshift(head);
            
            // –£–¥–∞–ª—è–µ–º —Ö–≤–æ—Å—Ç –µ—Å–ª–∏ –∑–º–µ–π–∫–∞ –Ω–µ –≤—ã—Ä–æ—Å–ª–∞
            if (snake.length > snakeLength) {
                snake.pop();
            }
        }

        function checkCollision() {
            const head = snake[0];
            
            // –°—Ç–µ–Ω—ã
            if (head.x < 0 || head.x >= canvas.width/gridSize || 
                head.y < 0 || head.y >= canvas.height/gridSize) {
                gameOver();
                return;
            }
            
            // –°–∞–º–∞ –≤ —Å–µ–±—è
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    gameOver();
                    return;
                }
            }
        }

        function checkFood() {
            const head = snake[0];
            
            if (head.x === food.x && head.y === food.y) {
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–º–µ–π–∫—É –∏ —Å—á–µ—Ç
                snakeLength++;
                currentScore += 10 * currentLevel;
                
                // –ü–æ–≤—ã—à–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∫–∞–∂–¥—ã–µ 100 –æ—á–∫–æ–≤
                const newLevel = Math.floor(currentScore / 100) + 1;
                if (newLevel > currentLevel) {
                    currentLevel = newLevel;
                    gameSpeed = Math.max(50, 150 - (currentLevel * 10)); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
                    clearInterval(gameLoop);
                    gameLoop = setInterval(updateGame, gameSpeed);
                }
                
                createFood();
                updateDisplay();
            }
        }

        function createFood() {
            food = {
                x: Math.floor(Math.random() * (canvas.width / gridSize)),
                y: Math.floor(Math.random() * (canvas.height / gridSize))
            };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ–±—ã –µ–¥–∞ –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–∞ –∑–º–µ–π–∫–µ
            for (let segment of snake) {
                if (segment.x === food.x && segment.y === food.y) {
                    createFood();
                    break;
                }
            }
        }

        function drawGame() {
            // –û—á–∏—â–∞–µ–º canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º –∑–º–µ–π–∫—É
            snake.forEach((segment, index) => {
                if (index === 0) {
                    ctx.fillStyle = '#4CAF50'; // –ì–æ–ª–æ–≤–∞
                } else {
                    ctx.fillStyle = '#8BC34A'; // –¢–µ–ª–æ
                }
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 1, gridSize - 1);
            });
            
            // –†–∏—Å—É–µ–º –µ–¥—É
            ctx.fillStyle = '#ff6b6b';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 1, gridSize - 1);
            
            // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            ctx.strokeStyle = '#333';
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        function gameOver() {
            isGameOver = true;
            clearInterval(gameLoop);
            
            document.getElementById('final-score').textContent = currentScore;
            document.getElementById('final-level').textContent = currentLevel;
            document.getElementById('gameOver').style.display = 'block';
        }

        function handleKeyPress(e) {
            if (isPaused || isGameOver) return;
            
            switch(e.key) {
                case 'ArrowUp': if (direction !== 'down') direction = 'up'; break;
                case 'ArrowDown': if (direction !== 'up') direction = 'down'; break;
                case 'ArrowLeft': if (direction !== 'right') direction = 'left'; break;
                case 'ArrowRight': if (direction !== 'left') direction = 'right'; break;
                case ' ': pauseGame(); break; // –ü—Ä–æ–±–µ–ª –¥–ª—è –ø–∞—É–∑—ã
            }
        }

        function changeDirection(newDirection) {
            if (isPaused || isGameOver) return;
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–≤–æ—Ä–æ—Ç –Ω–∞ 180 –≥—Ä–∞–¥—É—Å–æ–≤
            if ((newDirection === 'up' && direction !== 'down') ||
                (newDirection === 'down' && direction !== 'up') ||
                (newDirection === 'left' && direction !== 'right') ||
                (newDirection === 'right' && direction !== 'left')) {
                direction = newDirection;
            }
        }

        function updateDisplay() {
            document.getElementById('current-score').textContent = currentScore;
            document.getElementById('current-level').textContent = currentLevel;
            document.getElementById('snake-length').textContent = snakeLength;
        }

        // üîÑ –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–• –û–°–¢–ê–ï–¢–°–Ø –ü–†–ï–ñ–ù–ò–ú
        function initSupabase() {
            return {
                async query(sql) {
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify({ query: sql })
                        });
                        return await response.json();
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ Supabase:', error);
                        return getFromLocalStorage();
                    }
                },
                
                async insertScore(name, score, level) {
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/scores`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify({
                                player_name: name,
                                score: score,
                                level: level,
                                created_at: new Date().toISOString()
                            })
                        });
                        return await response.json();
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                        saveToLocalStorage(name, score, level);
                        return { success: true };
                    }
                }
            };
        }

        const supabase = initSupabase();

        function getFromLocalStorage() {
            const scores = JSON.parse(localStorage.getItem('snakeScores') || '[]');
            const personal = JSON.parse(localStorage.getItem('snakePersonalBest') || '[]');
            return { scores, personal };
        }

        function saveToLocalStorage(name, score, level) {
            const scores = JSON.parse(localStorage.getItem('snakeScores') || '[]');
            scores.push({ player_name: name, score, level, created_at: new Date().toISOString() });
            
            scores.sort((a, b) => b.score - a.score);
            const topScores = scores.slice(0, 10);
            localStorage.setItem('snakeScores', JSON.stringify(topScores));
            
            const personal = JSON.parse(localStorage.getItem('snakePersonalBest') || '[]');
            personal.push({ score, level, created_at: new Date().toISOString() });
            personal.sort((a, b) => b.score - a.score);
            const topPersonal = personal.slice(0, 5);
            localStorage.setItem('snakePersonalBest', JSON.stringify(topPersonal));
        }

        async function saveScore() {
            playerName = document.getElementById('player-name').value.trim() || '–ê–Ω–æ–Ω–∏–º–Ω—ã–π –∏–≥—Ä–æ–∫';
            
            if (currentScore > 0) {
                await supabase.insertScore(playerName, currentScore, currentLevel);
                await loadScores();
                alert(`–†–µ–∫–æ—Ä–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω! ${playerName}: ${currentScore} –æ—á–∫–æ–≤`);
            } else {
                alert('–°—ã–≥—Ä–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞—É–Ω–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!');
            }
        }

        async function loadScores() {
            try {
                const leaderboardData = await supabase.query(
                    'SELECT player_name, score, level, created_at FROM scores ORDER BY score DESC LIMIT 10'
                );
                
                const personalData = await supabase.query(
                    'SELECT score, level, created_at FROM scores ORDER BY score DESC LIMIT 5'
                );

                updateLeaderboard(leaderboardData.scores || []);
                updatePersonalResults(personalData.personal || []);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                const fallbackData = getFromLocalStorage();
                updateLeaderboard(fallbackData.scores);
                updatePersonalResults(fallbackData.personal);
            }
        }

        function updateLeaderboard(scores) {
            const leaderboardElement = document.getElementById('leaderboard');
            
            if (scores.length === 0) {
                leaderboardElement.innerHTML = '<div class="score-item">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';
                return;
            }
            
            leaderboardElement.innerHTML = scores.map((player, index) => `
                <div class="score-item ${player.score === personalBest ? 'new-record' : ''}">
                    <div class="score">${index + 1}. ${player.player_name} - ${player.score} –æ—á–∫–æ–≤</div>
                    <div class="level">–£—Ä–æ–≤–µ–Ω—å: ${player.level}</div>
                    <div class="date">${new Date(player.created_at).toLocaleDateString('ru-RU')}</div>
                </div>
            `).join('');
        }

        function updatePersonalResults(scores) {
            const personalResultsElement = document.getElementById('personal-results');
            
            if (scores.length === 0) {
                personalResultsElement.innerHTML = '<div class="score-item">–ü–æ–∫–∞ –Ω–µ—Ç –≤–∞—à–∏—Ö —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';
                return;
            }
            
            if (scores.length > 0) {
                personalBest = scores[0].score;
            }
            
            personalResultsElement.innerHTML = scores.map((score, index) => `
                <div class="score-item ${index === 0 ? 'new-record' : ''}">
                    <div class="score">${index + 1}. ${score.score} –æ—á–∫–æ–≤</div>
                    <div class="level">–£—Ä–æ–≤–µ–Ω—å: ${score.level}</div>
                    <div class="date">${new Date(score.created_at).toLocaleDateString('ru-RU')}</div>
                </div>
            `).join('');
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            initGame();
            drawGame(); // –ù–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
            setInterval(() => {
                if (currentScore > 0 && playerName && !isGameOver) {
                    saveScore();
                }
            }, 30000);
        });
    </script>
</body>
</html>