<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–º–µ–π–∫–∞</title>
    <link rel="icon" href="snakeHAV.png" type="image/png">
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –≤—Ö–æ–¥–∞ */
        .login-container { 
            background: white; 
            border-radius: 20px; 
            padding: 40px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
            display: block;
        }
        
        .game-title { 
            color: #333; 
            margin-bottom: 30px; 
            font-size: 2.5em; 
        }
        
        .game-subtitle { 
            color: #666; 
            margin-bottom: 40px; 
            font-size: 1.1em; 
            line-height: 1.5; 
        }
        
        .input-group { 
            margin-bottom: 25px; 
            text-align: left; 
        }
        
        .input-group label { 
            display: block; 
            color: #333; 
            margin-bottom: 8px; 
            font-weight: bold; 
            font-size: 0.9em; 
        }
        
        .input-group input { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #e1e5e9; 
            border-radius: 10px; 
            font-size: 1em; 
            transition: all 0.3s; 
        }
        
        .input-group input:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
        }
        
        .login-btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 1.1em; 
            font-weight: bold; 
            width: 100%; 
            transition: transform 0.2s, box-shadow 0.2s; 
            margin-bottom: 20px; 
        }
        
        .login-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        
        .register-link { 
            color: #667eea; 
            text-decoration: none; 
            font-weight: bold; 
            transition: color 0.3s; 
        }
        
        .register-link:hover { 
            color: #764ba2; 
            text-decoration: underline; 
        }
        
        .snake-icon { 
            font-size: 3em; 
            margin-bottom: 20px; 
            display: block; 
        }
        
        .form-divider { 
            margin: 25px 0; 
            color: #999; 
            font-size: 0.9em; 
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ */
        .game-screen { 
            display: none; 
            width: 100%; 
            max-width: 1200px; 
        }
        
        .container { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        
        .game-layout { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        
        @media (min-width: 1024px) { 
            .game-layout { 
                grid-template-columns: 1fr 400px; 
            } 
        }
        
        .game-container { 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        
        #gameCanvas { 
            border: 3px solid #333; 
            border-radius: 10px; 
            background: #000; 
            display: block; 
            max-width: 100%; 
            height: auto; 
        }
        
        .game-controls { 
            text-align: center; 
            margin: 10px 0; 
            width: 100%; 
        }
        
        .controls { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 8px; 
        }
        
        .controls button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.9em; 
            transition: transform 0.2s; 
            min-width: 120px; 
        }
        
        .controls button:hover { 
            transform: translateY(-2px); 
        }
        
        .section { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 10px; 
            border: 2px solid #e9ecef; 
            margin-bottom: 15px; 
        }
        
        .section h2 { 
            color: #495057; 
            margin-bottom: 15px; 
            font-size: 1.2em; 
            border-bottom: 2px solid #dee2e6; 
            padding-bottom: 8px; 
        }
        
        .score-item { 
            background: white; 
            padding: 12px; 
            margin: 8px 0; 
            border-radius: 8px; 
            border-left: 4px solid #667eea; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            font-size: 0.9em; 
        }
        
        .score-item.my-score { 
            border-left-color: #ff6b6b; 
            background: #fff5f5; 
        }
        
        .score-item .score { 
            font-size: 1.1em; 
            font-weight: bold; 
            color: #333; 
        }
        
        .score-item .player { 
            color: #666; 
            font-size: 1em; 
            font-weight: bold; 
        }
        
        .score-item .level { 
            color: #666; 
            font-size: 0.8em; 
        }
        
        .score-item .date { 
            color: #888; 
            font-size: 0.7em; 
            text-align: right; 
        }
        
        .current-stats { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); 
            color: white; 
            padding: 15px; 
            border-radius: 10px; 
            text-align: center; 
            margin-bottom: 42px;
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin: 10px 0; 
        }
        
        .stat { 
            text-align: center; 
        }
        
        .stat-value { 
            font-size: 1.5em; 
            font-weight: bold; 
        }
        
        .stat-label { 
            font-size: 0.8em; 
            opacity: 0.9; 
        }
        
        .player-info { 
            background: linear-gradient(135deg, #764ba2 0%, #764ba2 100%); 
            color: white; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            text-align: center; 
        }
        
        .loading { 
            text-align: center; 
            color: #666; 
            font-style: italic; 
        }
        
        .new-record { 
            animation: pulse 1s infinite; 
            background: linear-gradient(135deg, #ffd93d 0%, #ff6b6b 100%) !important; 
        }
        
        @keyframes pulse { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.05); } 
            100% { transform: scale(1); } 
        }
        
        .game-over { 
            position: absolute; 
            top: 25%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: rgba(0, 0, 0, 0.9); 
            color: white; 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
            display: none; 
            width: 90%; 
            max-width: 300px; 
        }
        
        .game-over h2 { 
            color: #ff6b6b; 
            margin-bottom: 10px; 
            font-size: 1.5em; 
        }
        
        .mobile-controls { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            grid-template-rows: repeat(2, 1fr); 
            gap: 8px; 
            margin-top: 15px; 
            width: 100%; 
            max-width: 300px; 
        }
        
        @media (min-width: 769px) { 
            .mobile-controls { 
                display: none; 
            } 
        }
        
        .mobile-controls button { 
            background: rgba(102, 126, 234, 0.8); 
            color: white; 
            border: none; 
            padding: 15px; 
            font-size: 1.2em; 
            border-radius: 10px; 
            min-height: 60px; 
        }
        
        .control-up { 
            grid-column: 2; 
            grid-row: 1; 
        }
        
        .control-left { 
            grid-column: 1; 
            grid-row: 2; 
        }
        
        .control-right { 
            grid-column: 3; 
            grid-row: 2; 
        }
        
        .control-down { 
            grid-column: 2; 
            grid-row: 2; 
        }
        
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        .refresh-btn { 
            background: #6c757d !important; 
            color: white !important;
            border: none !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 0.85em !important;
            margin-bottom: 10px;
            transition: all 0.2s !important;
            width: auto !important;
            min-width: auto !important;
            display: inline-block !important;
        }
        
        .refresh-btn:hover {
            background: #5a6268 !important;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .logout-btn { 
            background: #dc3545 !important; 
            color: white !important;
            border: none !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 0.85em !important;
            margin-top: 10px;
            transition: all 0.2s !important;
            width: auto !important;
            min-width: auto !important;
            display: inline-block !important;
        }
        
        .logout-btn:hover {
            background: #c82333 !important;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .skin-options { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
            margin-top: 10px; 
        }
        
        .skin-option { 
            padding: 10px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s; 
        }
        
        .skin-option.selected { 
            border-color: #667eea; 
            background: #f0f4ff; 
        }
        
        .skin-preview { 
            width: 30px; 
            height: 30px; 
            margin: 0 auto 5px; 
            border-radius: 4px; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
        }
        
        .modal-content { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            width: 90%; 
            max-width: 400px; 
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å–µ–∫—Ü–∏–π */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-header h2 {
            margin: 0;
            border: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div class="login-container" id="loginScreen">
        <div class="snake-icon">üêç</div>
        <h1 class="game-title">–ó–º–µ–π–∫–∞</h1>
        <p class="game-subtitle">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π —Ä–µ–∫–æ—Ä–¥–æ–≤</p>
        
        <div class="input-group">
            <label>–ù–∏–∫–Ω–µ–π–º</label>
            <input type="text" id="username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
        </div>
        
        <div class="input-group">
            <label>–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" maxlength="20">
        </div>
        
        <button class="login-btn" id="loginBtn">–í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É</button>
        
        <div class="form-divider">–∏–ª–∏</div>
        
        <a href="#" class="register-link" id="registerLink">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
    </div>

    <!-- –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω -->
    <div class="game-screen" id="gameScreen">
        <div class="container">
            <h1>üêç –ó–º–µ–π–∫–∞ - –ò–≥—Ä–∞</h1>
            
            <div class="player-info">
                <h2>–ò–≥—Ä–æ–∫: <span id="current-player">–ì–æ—Å—Ç—å</span></h2>
                <button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
            </div>

            <div class="game-layout">
                <div class="game-container">
                    <canvas id="gameCanvas" width="600" height="400"></canvas>
                    
                    <div class="game-controls">
                        <div class="controls">
                            <button id="startBtn">üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                            <button id="pauseBtn">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
                            <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button id="skinBtn">üé® –°–∫–∏–Ω—ã</button>
                        </div>
                    </div>
                    
                    <div class="mobile-controls">
                        <button class="control-up" id="upBtn">‚Üë</button>
                        <button class="control-left" id="leftBtn">‚Üê</button>
                        <button class="control-right" id="rightBtn">‚Üí</button>
                        <button class="control-down" id="downBtn">‚Üì</button>
                    </div>
                    
                    <div class="current-stats">
                        <h2>–¢–µ–∫—É—â–∞—è –∏–≥—Ä–∞</h2>
                        <div class="stats-grid">
                            <div class="stat">
                                <div class="stat-value" id="current-score">0</div>
                                <div class="stat-label">–û–ß–ö–ò</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="current-level">1</div>
                                <div class="stat-label">–£–†–û–í–ï–ù–¨</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="snake-length">1</div>
                                <div class="stat-label">–î–õ–ò–ù–ê</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="gameOver" class="game-over">
                        <h2>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h2>
                        <p>–í–∞—à —Å—á–µ—Ç: <span id="final-score">0</span></p>
                        <p>–£—Ä–æ–≤–µ–Ω—å: <span id="final-level">1</span></p>
                        <button id="restartBtn">üîÑ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                </div>
                
                <div class="sidebar">
                    <div class="section">
                        <div class="section-header">
                            <h2>üèÜ –í–∞—à–∏ –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
                            <button class="refresh-btn" id="refreshPersonalBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                        <div id="personal-results" class="loading">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–µ–∫–æ—Ä–¥–æ–≤</div>
                    </div>
                    
                    <div class="section">
                        <div class="section-header">
                            <h2>üìä –û–±—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h2>
                            <button class="refresh-btn" id="refreshLeaderboardBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                        <div id="leaderboard" class="loading">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="skinModal" class="modal">
            <div class="modal-content">
                <h2>üé® –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∏–Ω</h2>
                <div class="skin-options">
                    <div class="skin-option selected" id="classicSkin">
                        <div class="skin-preview" style="background: linear-gradient(135deg, #4CAF50, #8BC34A);"></div>
                        <div>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</div>
                    </div>
                    <div class="skin-option" id="fireSkin">
                        <div class="skin-preview" style="background: linear-gradient(135deg, #ff6b6b, #ffa726);"></div>
                        <div>–û–≥–Ω–µ–Ω–Ω—ã–π</div>
                    </div>
                    <div class="skin-option" id="iceSkin">
                        <div class="skin-preview" style="background: linear-gradient(135deg, #4FC3F7, #29B6F6);"></div>
                        <div>–õ–µ–¥—è–Ω–æ–π</div>
                    </div>
                    <div class="skin-option" id="rainbowSkin">
                        <div class="skin-preview" style="background: linear-gradient(135deg, #FF4081, #7C4DFF);"></div>
                        <div>–†–∞–¥—É–∂–Ω—ã–π</div>
                    </div>
                </div>
                <button id="closeSkinBtn" style="width: 100%; margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';
            
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
            const SUPABASE_URL = 'https://uxkbeldvmmayqflsqpzw.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4a2JlbGR2bW1heXFmbHNxcHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MDk0OTcsImV4cCI6MjA3NjI4NTQ5N30.55B-bBS0yAD4G1srxbPx0CdwSCZgnS2gycAg_hLmwb0';

            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
            let canvas, ctx;
            let snake = [];
            let food = {};
            let gridSize = 20;
            let direction = 'right';
            let gameLoop;
            let isPaused = false;
            let isGameOver = false;
            let currentScore = 0;
            let currentLevel = 1;
            let snakeLength = 1;
            let gameSpeed = 150;
            let playerName = '';
            let currentSkin = 'classic';

            const skins = {
                classic: { head: '#4CAF50', body: '#8BC34A', food: '#ff6b6b' },
                fire: { head: '#ff6b6b', body: '#ffa726', food: '#4FC3F7' },
                ice: { head: '#4FC3F7', body: '#29B6F6', food: '#ff6b6b' },
                rainbow: { head: '#FF4081', body: '#7C4DFF', food: '#4CAF50' }
            };

            // –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            function login() {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (!username || !password) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                    return;
                }
                
                const savedPassword = localStorage.getItem(`snake_password_${username}`);
                if (!savedPassword) {
                    alert('–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω! –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —Å–Ω–∞—á–∞–ª–∞.');
                    return;
                }
                
                if (savedPassword !== password) {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                    return;
                }
                
                playerName = username;
                localStorage.setItem('currentPlayer', username);
                showGameScreen();
            }
            
            function register() {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (!username || !password) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                    return;
                }
                
                const existingPassword = localStorage.getItem(`snake_password_${username}`);
                if (existingPassword) {
                    alert('–≠—Ç–æ—Ç –Ω–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç!');
                    return;
                }
                
                localStorage.setItem(`snake_password_${username}`, password);
                playerName = username;
                localStorage.setItem('currentPlayer', username);
                
                alert('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!');
                showGameScreen();
            }
            
            function logout() {
                localStorage.removeItem('currentPlayer');
                showLoginScreen();
            }
            
            function showLoginScreen() {
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('gameScreen').style.display = 'none';
            }
            
            function showGameScreen() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'block';
                document.getElementById('current-player').textContent = playerName;
                initGame();
                loadScores();
            }

            // –§—É–Ω–∫—Ü–∏–∏ –∏–≥—Ä—ã
            function initGame() {
                canvas = document.getElementById('gameCanvas');
                ctx = canvas.getContext('2d');
                adjustCanvasSize();
                resetGame();
                document.addEventListener('keydown', handleKeyPress);
                window.addEventListener('resize', adjustCanvasSize);
            }

            function adjustCanvasSize() {
                const container = document.querySelector('.game-container');
                const maxWidth = container.clientWidth - 40;
                const aspectRatio = 600 / 400;
                const newWidth = Math.min(600, maxWidth);
                const newHeight = newWidth / aspectRatio;
                
                canvas.style.width = newWidth + 'px';
                canvas.style.height = newHeight + 'px';
            }

            function resetGame() {
                snake = [{x: 5, y: 10}];
                snakeLength = 1;
                createFood();
                currentScore = 0;
                currentLevel = 1;
                gameSpeed = 150;
                direction = 'right';
                isGameOver = false;
                isPaused = false;
                updatePauseButton();
                document.getElementById('gameOver').style.display = 'none';
                updateDisplay();
            }

            function startGame() {
                if (!playerName) { alert('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!'); return; }
                if (gameLoop) clearInterval(gameLoop);
                resetGame();
                gameLoop = setInterval(updateGame, gameSpeed);
            }

            function togglePause() {
                if (isGameOver) return;
                isPaused = !isPaused;
                updatePauseButton();
                if (isPaused) clearInterval(gameLoop);
                else gameLoop = setInterval(updateGame, gameSpeed);
            }

            function updatePauseButton() {
                document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '‚è∏Ô∏è –ü–∞—É–∑–∞';
            }

            function updateGame() {
                if (isPaused || isGameOver) return;
                moveSnake();
                checkCollision();
                checkFood();
                drawGame();
            }

            function moveSnake() {
                const head = {...snake[0]};
                switch(direction) {
                    case 'up': head.y--; break;
                    case 'down': head.y++; break;
                    case 'left': head.x--; break;
                    case 'right': head.x++; break;
                }
                snake.unshift(head);
                if (snake.length > snakeLength) snake.pop();
            }

            function checkCollision() {
                const head = snake[0];
                if (head.x < 0 || head.x >= canvas.width/gridSize || head.y < 0 || head.y >= canvas.height/gridSize) {
                    gameOver(); return;
                }
                for (let i = 1; i < snake.length; i++) {
                    if (head.x === snake[i].x && head.y === snake[i].y) {
                        gameOver(); return;
                    }
                }
            }

            function checkFood() {
                const head = snake[0];
                if (head.x === food.x && head.y === food.y) {
                    snakeLength++;
                    currentScore += 10 * currentLevel;
                    const newLevel = Math.floor(currentScore / 100) + 1;
                    if (newLevel > currentLevel) {
                        currentLevel = newLevel;
                        gameSpeed = Math.max(50, 150 - (currentLevel * 10));
                        clearInterval(gameLoop);
                        gameLoop = setInterval(updateGame, gameSpeed);
                    }
                    createFood();
                    updateDisplay();
                }
            }

            function createFood() {
                food = {
                    x: Math.floor(Math.random() * (canvas.width / gridSize)),
                    y: Math.floor(Math.random() * (canvas.height / gridSize))
                };
                for (let segment of snake) {
                    if (segment.x === food.x && segment.y === food.y) {
                        createFood(); break;
                    }
                }
            }

            function drawGame() {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const skin = skins[currentSkin];
                
                snake.forEach((segment, index) => {
                    ctx.fillStyle = index === 0 ? skin.head : skin.body;
                    ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 1, gridSize - 1);
                });
                
                ctx.fillStyle = skin.food;
                ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 1, gridSize - 1);
            }

            function gameOver() {
                isGameOver = true;
                clearInterval(gameLoop);
                document.getElementById('final-score').textContent = currentScore;
                document.getElementById('final-level').textContent = currentLevel;
                document.getElementById('gameOver').style.display = 'block';
            }

            function handleKeyPress(e) {
                if (isPaused || isGameOver) return;
                switch(e.key) {
                    case 'ArrowUp': if (direction !== 'down') direction = 'up'; break;
                    case 'ArrowDown': if (direction !== 'up') direction = 'down'; break;
                    case 'ArrowLeft': if (direction !== 'right') direction = 'left'; break;
                    case 'ArrowRight': if (direction !== 'left') direction = 'right'; break;
                    case ' ': togglePause(); break;
                }
            }

            function changeDirection(newDirection) {
                if (isPaused || isGameOver) return;
                if ((newDirection === 'up' && direction !== 'down') ||
                    (newDirection === 'down' && direction !== 'up') ||
                    (newDirection === 'left' && direction !== 'right') ||
                    (newDirection === 'right' && direction !== 'left')) {
                    direction = newDirection;
                }
            }

            function updateDisplay() {
                document.getElementById('current-score').textContent = currentScore;
                document.getElementById('current-level').textContent = currentLevel;
                document.getElementById('snake-length').textContent = snakeLength;
            }

            // –°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤
            const supabase = {
                async fetchScores() {
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/scores?select=*&order=score.desc.nullslast`, {
                            headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                        });
                        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                        return await response.json();
                    } catch (error) {
                        return getFromLocalStorage();
                    }
                },
                
                async insertScore(name, score, level) {
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/scores`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` },
                            body: JSON.stringify({ player_name: name, score: score, level: level, created_at: new Date().toISOString() })
                        });
                        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                        return await response.json();
                    } catch (error) {
                        saveToLocalStorage(name, score, level);
                        return { success: true };
                    }
                }
            };

            function getFromLocalStorage() {
                return JSON.parse(localStorage.getItem('allSnakeScores') || '[]');
            }

            function saveToLocalStorage(name, score, level) {
                const scores = JSON.parse(localStorage.getItem('allSnakeScores') || '[]');
                scores.push({ player_name: name, score: score, level: level, created_at: new Date().toISOString() });
                scores.sort((a, b) => b.score - a.score);
                const topScores = scores.slice(0, 50);
                localStorage.setItem('allSnakeScores', JSON.stringify(topScores));
            }

            async function saveScore() {
                if (!playerName) { alert('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!'); return; }
                if (currentScore > 0) {
                    await supabase.insertScore(playerName, currentScore, currentLevel);
                    await loadScores();
                } else { alert('–°—ã–≥—Ä–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞—É–Ω–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!'); }
            }

            async function loadScores() {
                if (!playerName) return;
                
                try {
                    const allScores = await supabase.fetchScores();
                    updateLeaderboard(allScores);
                    updatePersonalResults(allScores);
                } catch (error) {
                    const fallbackData = getFromLocalStorage();
                    updateLeaderboard(fallbackData);
                    updatePersonalResults(fallbackData);
                }
            }

            function updateLeaderboard(allScores) {
                const leaderboardElement = document.getElementById('leaderboard');
                if (allScores.length === 0) {
                    leaderboardElement.innerHTML = '<div class="score-item">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';
                    return;
                }
                const topScores = allScores.slice(0, 10);
                leaderboardElement.innerHTML = topScores.map((score, index) => {
                    const isMyScore = score.player_name === playerName;
                    return `<div class="score-item ${isMyScore ? 'my-score' : ''}">
                        <div class="player">${index + 1}. ${score.player_name}</div>
                        <div class="score">${score.score} –æ—á–∫–æ–≤</div>
                        <div class="level">–£—Ä–æ–≤–µ–Ω—å: ${score.level}</div>
                        <div class="date">${new Date(score.created_at).toLocaleDateString('ru-RU')}</div>
                    </div>`;
                }).join('');
            }

            function updatePersonalResults(allScores) {
                const personalResultsElement = document.getElementById('personal-results');
                const myScores = allScores.filter(score => score.player_name === playerName);
                if (myScores.length === 0) {
                    personalResultsElement.innerHTML = '<div class="score-item">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';
                    return;
                }
                personalResultsElement.innerHTML = myScores.map((score, index) => `
                    <div class="score-item my-score ${index === 0 ? 'new-record' : ''}">
                        <div class="score">${index + 1}. ${score.score} –æ—á–∫–æ–≤</div>
                        <div class="level">–£—Ä–æ–≤–µ–Ω—å: ${score.level}</div>
                        <div class="date">${new Date(score.created_at).toLocaleDateString('ru-RU')}</div>
                    </div>
                `).join('');
            }

            // –°–∏—Å—Ç–µ–º–∞ —Å–∫–∏–Ω–æ–≤
            function showSkinModal() {
                document.getElementById('skinModal').style.display = 'block';
            }

            function hideSkinModal() {
                document.getElementById('skinModal').style.display = 'none';
            }

            function selectSkin(skin) {
                currentSkin = skin;
                document.querySelectorAll('.skin-option').forEach(opt => opt.classList.remove('selected'));
                event.target.closest('.skin-option').classList.add('selected');
                if (!isPaused && !isGameOver) drawGame();
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            function initEventListeners() {
                document.getElementById('loginBtn').addEventListener('click', login);
                document.getElementById('registerLink').addEventListener('click', register);
                document.getElementById('logoutBtn').addEventListener('click', logout);
                document.getElementById('startBtn').addEventListener('click', startGame);
                document.getElementById('pauseBtn').addEventListener('click', togglePause);
                document.getElementById('saveBtn').addEventListener('click', saveScore);
                document.getElementById('skinBtn').addEventListener('click', showSkinModal);
                document.getElementById('restartBtn').addEventListener('click', startGame);
                document.getElementById('refreshPersonalBtn').addEventListener('click', loadScores);
                document.getElementById('refreshLeaderboardBtn').addEventListener('click', loadScores);
                document.getElementById('closeSkinBtn').addEventListener('click', hideSkinModal);
                
                document.getElementById('upBtn').addEventListener('click', () => changeDirection('up'));
                document.getElementById('downBtn').addEventListener('click', () => changeDirection('down'));
                document.getElementById('leftBtn').addEventListener('click', () => changeDirection('left'));
                document.getElementById('rightBtn').addEventListener('click', () => changeDirection('right'));
                
                document.getElementById('classicSkin').addEventListener('click', () => selectSkin('classic'));
                document.getElementById('fireSkin').addEventListener('click', () => selectSkin('fire'));
                document.getElementById('iceSkin').addEventListener('click', () => selectSkin('ice'));
                document.getElementById('rainbowSkin').addEventListener('click', () => selectSkin('rainbow'));
                
                document.getElementById('password').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('username').focus();
                initEventListeners();
                
                const currentPlayer = localStorage.getItem('currentPlayer');
                if (currentPlayer) {
                    playerName = currentPlayer;
                    showGameScreen();
                } else {
                    showLoginScreen();
                }
            });
        })();
    </script>
</body>
</html>





